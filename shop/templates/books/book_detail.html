{% extends "base_generic.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book.css' %}">
{% endblock %}
{% block content %}
<div class="book-detail">
    <div class="book-header">
        <div class="left-side">
            <img src="{{ object.image.url }}" class="book-avatar">
            <h1>{{ object.name }}</h1>
            <p class="author">{{ object.author }}</p>
            <p class="price">{{ object.list_price }}￥</p>
        </div>
        <div class="right-side">
            <div class="purchase-form">
                <h2 class="form-title">Purchase Form</h2>
                <form id="purchase-form" method="post" action="{% url 'checkout' object.id %}">
                    {% csrf_token %}
                    {% for field in form %}
                    <div class="form-group">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}
                        <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <div class="buttons">
                        <button type="submit" class="btn btn-primary">购买</button>
                        <button type="button" id="add-to-cart" class="btn btn-secondary">加入购物车</button>
                        <button type="button" id="add-to-collection" class="btn btn-secondary">收藏</button>
                    </div>
                </form>
            </div>
            <div class="fixed-sidebar">
                <ul>
                    <li><a href="{% url 'order_list' %}">Orders</a></li>
                    <li><a href="{% url 'comment' %}">Comments</a></li>
                    <li><a href="{% url 'collection' %}">Collections</a></li>
                    <li><a href="{% url 'cart' %}">Cart</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<h2>Description</h2>
<div class="description">
    {{ object.description }}
</div>

<h2>Comments</h2>
<div class="comments">
    {% for comment in comments %}
    <div class="comment">
        <p><strong>{{ comment.user.username }}:</strong> {{ comment.text_content }}</p>
        <p><em>{{ comment.comment_date }}</em></p>
    </div>
    {% empty %}
    <p>No comments yet.</p>
    {% endfor %}
</div>

<form id="add-comment-form" method="post" action="{% url 'add_comment' object.id %}">
    {% csrf_token %}
    <textarea name="text_content" placeholder="添加评论"></textarea>
    <button type="submit" class="btn btn-primary">提交评论</button>
</form>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const handleFormSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            const url = form.action;
            const method = form.method;

            fetch(url, {
                method: method,
                body: new FormData(form),
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.status === "success") {
                    alert(data.message);
                } else {
                    alert("操作失败，请重试。");
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert("操作失败，请重试。");
            });
        };

        document.getElementById("purchase-form").addEventListener("submit", handleFormSubmit);

        const handleButtonClick = (url, csrfToken) => {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrfToken);
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.status === "success") {
                    alert(data.message);
                } else {
                    alert("操作失败，请重试。");
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert("操作失败，请重试。");
            });
        };

        document.getElementById("add-to-cart").addEventListener("click", () => {
            handleButtonClick("{% url 'add_to_cart' object.id %}", '{{ csrf_token }}');
        });

        document.getElementById("add-to-collection").addEventListener("click", () => {
            handleButtonClick("{% url 'add_to_collection' object.id %}", '{{ csrf_token }}');
        });
    });
</script>
{% endblock %}
